---
import { getCollection, getEntry, render } from 'astro:content';
import { siteConfig } from '@/config';
import { generatePostsListSEO } from '@/utils/seo';
import { shouldShowContent, sortPostsByDate, isValidDate } from '@/utils/markdown';
import { hasProjectCategories, getProjectCategories } from '@/utils/categories';
import BaseLayout from '@/layouts/BaseLayout.astro';
import PageLayout from '@/layouts/PageLayout.astro';
import ProjectCard from '@/components/ProjectCard.astro';
import ProjectCategories from '@/components/ProjectCategories.astro';
import Icon from '@/components/Icon.astro';

// 检查项目是否启用并处理回退
let fallbackPage = null;

if (!siteConfig.optionalContentTypes.projects) {
  // 检查 pages 集合中的回退页面
  try {
    fallbackPage = await getEntry('pages', 'projects');
    if (fallbackPage) {
      // PageLayout 将处理渲染
    } else {
      return Astro.redirect('/404');
    }
  } catch (error) {
    // 未找到回退页面，重定向到 404
    return Astro.redirect('/404');
  }
}

// 获取所有项目
const allProjects = await getCollection('projects');
const isDev = import.meta.env.DEV;

// 过滤和排序项目（最新的在前）
const visibleProjects = allProjects
  .filter(project => shouldShowContent(project, isDev))
  .sort((a, b) => {
    const dateA = isValidDate(a.data.date) ? a.data.date : new Date(0);
    const dateB = isValidDate(b.data.date) ? b.data.date : new Date(0);
    return dateB.getTime() - dateA.getTime();
  });

// 检查是否有项目有分类并获取它们
const projectsHaveCategories = hasProjectCategories(visibleProjects);
const allCategories = projectsHaveCategories ? getProjectCategories(visibleProjects) : [];

// 从特殊集合获取项目页面内容
let projectsPageContent = null;
let ProjectsPageContent = null;

try {
  projectsPageContent = await getEntry('special', 'projects');
  if (projectsPageContent) {
    const { Content } = await render(projectsPageContent);
    ProjectsPageContent = Content;
  }
} catch (error) {
  // 如果 projects.md 不存在，回退到默认
}

// 生成 SEO 数据
const seoData = generatePostsListSEO(import.meta.env.SITE || '', undefined);
seoData.title = projectsPageContent?.data.title ? `${projectsPageContent.data.title} | ${siteConfig.title}` : `项目 | ${siteConfig.title}`;
seoData.description = projectsPageContent?.data.description || `浏览 ${siteConfig.title} 上的所有项目`;
seoData.noIndex = (projectsPageContent?.data as any)?.noIndex || false;
---

{fallbackPage ? (
  <PageLayout page={fallbackPage as any} />
) : (
<BaseLayout seoData={seoData}>
  <div class="py-8 relative">
    <div class="mx-auto px-4 sm:px-6 lg:px-8 mb-12" style={`max-width: ${siteConfig.layout.contentWidth}`}>
      <!-- 页面页眉 -->
      <header class="mb-8">
        <h1 class="text-lg font-bold text-primary-900 dark:text-primary-50 mb-3">
          {projectsPageContent?.data.title || '项目'}
        </h1>
        {ProjectsPageContent ? (
          <div class="prose prose-sm dark:prose-dark max-w-none">
            <ProjectsPageContent />
          </div>
        ) : (
          <p class="text-primary-600 dark:text-primary-300">
            我的工作和副项目集合
          </p>
        )}
      </header>

      <div class="relative">
        <!-- 主要内容 -->
        <div class="max-w-none">
          {visibleProjects.length > 0 ? (
            <>
              <!-- 项目网格 -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            {visibleProjects.map((project, index) => (
              <ProjectCard
                project={project}
                eager={index < 4}
                context="projects"
                showCategories={projectsHaveCategories}
              />
            ))}
              </div>
            </>
          ) : (
            <div class="text-center py-12">
              <Icon name="folder-open" class="w-12 h-12 text-primary-300 dark:text-primary-600 mx-auto mb-4" />
              <h3 class="text-lg font-medium text-primary-900 dark:text-primary-50 mb-2">
                暂无项目
              </h3>
              <p class="text-primary-600 dark:text-primary-300">
                请稍后再来查看新项目！
              </p>
            </div>
          )}
        </div>

        <!-- 移动端侧边栏 - 在手机/平板设备上显示在内容下方 -->
        <div class="xl:hidden mt-12 space-y-6">
          <!-- 分类 -->
          {siteConfig.postOptions.tags && projectsHaveCategories && allCategories.length > 0 && (
            <ProjectCategories categories={allCategories} />
          )}
        </div>

        <!-- 桌面端侧边栏 - 浮动在内容容器的右侧 -->
        <div class="hidden xl:block absolute top-0 left-full ml-8 w-64">
          <div class="sticky top-24 space-y-3 max-h-[calc(100vh-12rem)] overflow-y-auto pb-6">
            <!-- 分类 -->
            {siteConfig.postOptions.tags && projectsHaveCategories && allCategories.length > 0 && (
              <ProjectCategories categories={allCategories} />
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</BaseLayout>
)}