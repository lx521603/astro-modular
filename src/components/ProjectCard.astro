---
import type { CollectionEntry } from 'astro:content';
import { formatDate, processMarkdown, isValidDate } from '../utils/markdown';
import { siteConfig, getPostCardAspectRatio } from '../config';
import { normalizeStatus, getStatusDisplayText, hasStatusStyling, getStatusClasses } from '../utils/status';
import { optimizeContentImagePath, getOptimizedFormat } from '../utils/images';
import ImageWrapper from './ImageWrapper.astro';
import Icon from './Icon.astro';

interface Props {
  project: CollectionEntry<'projects'>;
  featured?: boolean;
  eager?: boolean;
  context?: 'featured' | 'recent' | 'projects' | 'tags' | 'home';
  showCategories?: boolean;
}

const { project, featured = false, eager = false, context = 'projects', showCategories = true } = Astro.props;

// 从 Markdown 处理中获取摘要
const { excerpt } = processMarkdown(project.body);

const { title, description: rawDescription, date, image: rawImage, imageAlt } = project.data;

// 处理图片字段中的 Obsidian 方括号语法（从 PostCard 复制）
const image = (() => {
  if (!rawImage) return rawImage;

  // 处理 rawImage 是数组的情况（未加引号的 YAML 语法）
  let imageValue = rawImage;
  if (Array.isArray(rawImage)) {
    // 如果是数组，取第一个元素
    imageValue = rawImage[0];
  }

  // 在调用字符串方法之前确保 imageValue 是字符串
  if (typeof imageValue !== 'string') {
    console.warn('ProjectCard: imageValue 不是字符串:', imageValue);
    return imageValue;
  }

  // 检查是否是 Obsidian 双括号语法
  if (imageValue.startsWith('[[') && imageValue.endsWith(']]')) {
    // 提取双括号内的内容
    return imageValue.slice(2, -2);
  }

  return imageValue;
})();

const description = rawDescription || excerpt;
const categories = project.data.categories || [];
const status = normalizeStatus(project.data.status);
const repositoryUrl = project.data.repositoryUrl;
const projectUrl = project.data.projectUrl;

// 确定是否应显示封面图片
// 项目在有图片时应始终显示图片（不受 postOptions 控制）
const shouldShowCoverImage = true;
---

<div class="group relative bg-white dark:bg-primary-800 rounded-xl border border-primary-200 dark:border-primary-700 overflow-hidden hover:shadow-xl transition-all duration-300 hover:-translate-y-1 aspect-[4/3]" data-project-categories={categories.join(',')}>
  <a href={`/projects/${project.id}`} class="block h-full" aria-label={`查看项目: ${title}`}>
    <!-- 背景图片或回退 -->
    {image && shouldShowCoverImage && (
      <div class="absolute inset-0">
        <ImageWrapper
          src={(() => {
            // 通过移除 Obsidian 括号来清理图片路径
            let cleanImagePath = image;
            if (!cleanImagePath || typeof cleanImagePath !== 'string') return '';
            if (cleanImagePath.startsWith('[[') && cleanImagePath.endsWith(']]')) {
              cleanImagePath = cleanImagePath.slice(2, -2);
            }

            // 移除 Obsidian 子文件夹前缀（images/, attachments/）
            if (typeof cleanImagePath === 'string') {
              // 如果存在则移除 images/ 前缀（Obsidian 子文件夹设置）
              if (cleanImagePath.startsWith('images/')) {
                cleanImagePath = cleanImagePath.replace('images/', '');
              }
              // 移除 attachments/ 前缀 - basePath 会重新添加它
              if (cleanImagePath.startsWith('attachments/')) {
                cleanImagePath = cleanImagePath.replace('attachments/', '');
              }
            }

            const finalSrc = cleanImagePath || '';
            // 如果适用则转换为 WebP（sync-images.js 会创建 WebP 版本）
            return getOptimizedFormat(finalSrc);
          })()}
          basePath={(() => {
            // 1. 外部 URL - 不需要 basePath
            if (typeof image === 'string' && image.startsWith('http')) {
              return '';
            }

            // 2. 清理图片路径以检查 attachments/ 前缀
            let cleanImagePath = image;
            if (typeof cleanImagePath === 'string' && cleanImagePath.startsWith('[[') && cleanImagePath.endsWith(']]')) {
              cleanImagePath = cleanImagePath.slice(2, -2);
            }

            // 3. 检测基于文件夹与基于文件：如果图片路径以 'attachments/' 开头，
            // 则是单文件项目（共享附件文件夹）
            if (typeof cleanImagePath === 'string' && cleanImagePath.startsWith('attachments/')) {
              // 图片在附件文件夹中的单文件项目
              // 同步脚本将这些复制到 /projects/attachments/
              return "/projects/attachments/";
            }

            // 4. 基于文件夹的项目 - 同步脚本将图片复制到项目文件夹根目录
            // 安全检查：在使用 project.id 之前确保它存在
            if (project.id) {
              return `/projects/${project.id}/`;
            } else {
              // 如果 project.id 未定义，回退到附件目录
              return '/projects/attachments/';
            }
          })()}
          alt={imageAlt || `项目封面图片: ${title}`}
          width={800}
          height={600}
          loading={eager ? 'eager' : 'lazy'}
          fetchpriority={eager ? 'high' : 'auto'}
          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
        />
        <!-- 深色叠加层以获得更好的文本可读性 -->
        <div class="absolute inset-0 bg-black/70 group-hover:bg-black/80 transition-colors duration-300"></div>
      </div>
    )}

    {!image && (
      <!-- 没有图片时的回退背景 -->
      <div class="absolute inset-0 bg-gradient-to-br from-primary-200 to-primary-300 dark:from-primary-700 dark:to-primary-800"></div>
    )}

    <!-- 状态徽章 -->
    {status && (
      <div class="absolute top-3 right-3 z-10">
        <span class={`px-2 py-1 rounded-full text-xs font-medium shadow-sm ${getStatusClasses(status)}`}>
          {getStatusDisplayText(status)}
        </span>
      </div>
    )}

    <!-- 日期 -->
    {isValidDate(date) && (
      <div class="absolute top-3 left-3 z-10">
        <time datetime={date.toISOString()} class={`text-xs font-mono px-2 py-1 rounded backdrop-blur-sm ${
          image && shouldShowCoverImage
            ? 'text-white/90 bg-black/20'
            : 'text-primary-700 dark:text-primary-200 bg-white/80 dark:bg-black/20'
        }`}>
          {formatDate(date)}
        </time>
      </div>
    )}

    <!-- 内容叠加层 -->
    <div class="absolute inset-0 flex flex-col p-6 z-10" style="padding-top: 4rem;">
      <!-- 间隔物，将内容从顶部元素向下推 -->
      <div class="flex-1"></div>

      <!-- 标题 -->
      <h3 class={`text-xl font-bold mb-2 transition-colors line-clamp-2 text-center ${
        image && shouldShowCoverImage
          ? 'text-white group-hover:text-highlight-300 drop-shadow-lg'
          : 'text-primary-900 dark:text-primary-50 group-hover:text-highlight-600 dark:group-hover:text-highlight-400'
      }`}>
        {title}
      </h3>

      <!-- 悬停内容 -->
      <div class="opacity-0 group-hover:opacity-100 transition-opacity duration-300">
        <!-- 描述 -->
        {description && (
          <p class={`text-sm mb-3 line-clamp-2 text-left ${
            image && shouldShowCoverImage
              ? 'text-white/90 drop-shadow-lg'
              : 'text-primary-700 dark:text-primary-300'
          }`}>
            {description}
          </p>
        )}

        <!-- 分类 -->
        {showCategories && categories.length > 0 && (
          <div class="flex flex-wrap gap-1 mb-3 justify-center">
            {categories.slice(0, 3).map(category => (
              <span class={`inline-flex items-center px-2 py-1 text-xs font-medium rounded backdrop-blur-sm ${
                image && shouldShowCoverImage
                  ? 'bg-white/20 text-white/90'
                  : 'bg-primary-100 dark:bg-primary-700 text-primary-700 dark:text-primary-200'
              }`}>
                {category}
              </span>
            ))}
            {categories.length > 3 && (
              <span class={`inline-flex items-center px-2 py-1 text-xs font-medium rounded backdrop-blur-sm ${
                image && shouldShowCoverImage
                  ? 'bg-white/20 text-white/90'
                  : 'bg-primary-100 dark:bg-primary-700 text-primary-700 dark:text-primary-200'
              }`}>
                +{categories.length - 3} 更多
              </span>
            )}
          </div>
        )}

      </div>
    </div>
  </a>
</div>