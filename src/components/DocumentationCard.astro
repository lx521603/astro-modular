---
import type { CollectionEntry } from 'astro:content';
import { formatDate, processMarkdown, isValidDate } from '../utils/markdown';
import { siteConfig } from '../config';
import ImageWrapper from './ImageWrapper.astro';
import Icon from './Icon.astro';

interface Props {
  documentation: CollectionEntry<'docs'>;
  featured?: boolean;
  eager?: boolean;
  context?: 'featured' | 'recent' | 'docs' | 'tags' | 'home';
}

const { documentation, featured = false, eager = false, context = 'docs' } = Astro.props;

// 从 Markdown 处理中获取摘要
const { excerpt } = processMarkdown(documentation.body);

const { title, description: rawDescription, lastModified, image: rawImage, imageAlt, category, version } = documentation.data;

// 处理图片字段中的 Obsidian 方括号语法（从 PostCard 复制）
const image = (() => {
  if (!rawImage) return rawImage;

  // 处理 rawImage 是数组的情况（未加引号的 YAML 语法）
  let imageValue = rawImage;
  if (Array.isArray(rawImage)) {
    // 如果是数组，取第一个元素
    imageValue = rawImage[0];
  }

  // 在调用字符串方法之前确保 imageValue 是字符串
  if (typeof imageValue !== 'string') {
    console.warn('DocumentationCard: imageValue 不是字符串:', imageValue);
    return imageValue;
  }

  // 检查是否是 Obsidian 双括号语法
  if (imageValue.startsWith('[[') && imageValue.endsWith(']]')) {
    // 提取双括号内的内容
    return imageValue.slice(2, -2);
  }

  return imageValue;
})();

const description = rawDescription || excerpt;

// 确定是否应显示封面图片
// 文档在有图片时应始终显示图片（不受 postOptions 控制）
const shouldShowCoverImage = true;

// 在首页隐藏文档图片以获得更简洁的外观
const showCoverImage = shouldShowCoverImage && image && context !== 'home';
---

<div class="group relative bg-white dark:bg-primary-800 rounded-lg border border-primary-200 dark:border-primary-700 hover:shadow-lg transition-all duration-300 hover:-translate-y-1">
  <a href={`/docs/${documentation.id}`} class="block" aria-label={`查看文档: ${title}`}>
    <!-- 带有图标和版本的页眉 -->
    <div class="flex items-center justify-between p-4 pb-2">
      <Icon name="book-text" class="w-4 h-4 text-primary-500 dark:text-primary-400" />
      {version && (
        <span class="text-xs text-primary-500 dark:text-primary-400 font-mono bg-primary-100 dark:bg-primary-700 px-2 py-1 rounded">
          v{version}
        </span>
      )}
    </div>

    <!-- 封面图片（如果存在） -->
    {image && showCoverImage && (
      <div class="px-4 pb-2">
        <div class="relative overflow-hidden rounded-md">
          <ImageWrapper
            src={(() => {
              // 通过移除 Obsidian 括号来清理图片路径
              // 移除 Obsidian 括号以获取实际的图片路径
              let cleanImagePath = image;
              if (typeof cleanImagePath === 'string' && cleanImagePath.startsWith('[[') && cleanImagePath.endsWith(']]')) {
                cleanImagePath = cleanImagePath.slice(2, -2);
              }

              // 移除 Obsidian 子文件夹前缀（images/, attachments/）
              if (typeof cleanImagePath === 'string') {
                // 如果存在则移除 images/ 前缀（Obsidian 子文件夹设置）
                if (cleanImagePath.startsWith('images/')) {
                  return cleanImagePath.replace('images/', '');
                }
                // 移除 attachments/ 前缀 - basePath 会重新添加它
                if (cleanImagePath.startsWith('attachments/')) {
                  return cleanImagePath.replace('attachments/', '');
                }
              }

              return cleanImagePath || '';
            })()}
            basePath={(() => {
              // 1. 外部 URL - 不需要 basePath
              if (typeof image === 'string' && image.startsWith('http')) {
                return '';
              }

              // 2. 清理图片路径以检查 attachments/ 前缀
              let cleanImagePath = image;
              if (typeof cleanImagePath === 'string' && cleanImagePath.startsWith('[[') && cleanImagePath.endsWith(']]')) {
                cleanImagePath = cleanImagePath.slice(2, -2);
              }

              // 3. 检测基于文件夹与基于文件：如果图片路径以 'attachments/' 开头，
              // 则是单文件文档（共享附件文件夹）
              if (typeof cleanImagePath === 'string' && cleanImagePath.startsWith('attachments/')) {
                // 图片在附件文件夹中的单文件文档
                // 同步脚本将这些复制到 /docs/attachments/
                return "/docs/attachments/";
              }

              // 4. 基于文件夹的文档 - 同步脚本将图片复制到文档文件夹根目录
              // 安全检查：在使用 documentation.id 之前确保它存在
              if (documentation.id) {
                return `/docs/${documentation.id}/`;
              } else {
                // 如果 documentation.id 未定义，回退到附件目录
                return '/docs/attachments/';
              }
            })()}
            alt={imageAlt || `文档封面图片: ${title}`}
            width={400}
            height={200}
            loading={eager ? 'eager' : 'lazy'}
            fetchpriority={eager ? 'high' : 'auto'}
            class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-300"
          />
        </div>
      </div>
    )}

    <!-- 内容 -->
    <div class="p-4 pt-2">
      <!-- 标题 -->
      <h3 class="text-lg font-semibold text-primary-900 dark:text-primary-50 mb-2 group-hover:text-highlight-600 dark:group-hover:text-highlight-400 transition-colors line-clamp-2">
        {title}
      </h3>

      <!-- 描述 -->
      {description && (
        <p class="text-sm text-primary-600 dark:text-primary-300 mb-3 line-clamp-3">
          {description}
        </p>
      )}

      <!-- 页脚 -->
      {lastModified && (
        <div class="pt-2 border-t border-primary-200 dark:border-primary-700">
          {isValidDate(lastModified) && (
            <time datetime={lastModified.toISOString()} class="text-xs text-primary-500 dark:text-primary-400">
              更新于 {lastModified.toLocaleDateString('zh-CN', { month: 'short', day: 'numeric' })}
            </time>
          )}
        </div>
      )}
    </div>
  </a>
</div>